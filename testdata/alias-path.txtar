# alias points to non-existent file
! exec maru2 -f workflow-resolve-error.yaml --list
stderr 'no such file or directory'

# alias points to invalid YAML content
! exec maru2 -f workflow-fetch-error.yaml --list
stderr 'string was used where mapping is expected'

# absolute paths not allowed in aliases
! exec maru2 -f workflow-absolute-path.yaml --list
stderr 'cannot be an absolute path'

# invalid URL characters in alias path
! exec maru2 -f workflow-invalid-url-chars.yaml --list
stderr 'invalid control character in URL'

# alias resolution functionality
exec maru2 -f workflow-with-aliases.yaml --list
stderr 'local-task'
stderr 'remote-task'
stderr 'local:echo-local'

# local alias resolution
exec maru2 -f workflow-with-aliases.yaml local-task
stdout 'Local alias resolved successfully'

# direct alias call
exec maru2 -f workflow-with-aliases.yaml local:echo-local

# task within alias not found
! exec maru2 -f workflow-with-aliases.yaml local:dne
stderr 'ERRO task "dne" not found'

# alias fails to resolve
! exec maru2 -f workflow-with-aliases.yaml dne:echo-local
stderr 'ERRO unsupported scheme: "dne" in "dne:echo-local"'

# alias fails to fetch
! exec maru2 -f workflow-resolve-error.yaml missing:anything
stderr 'ERRO stat does-not-exist.yaml: no such file or directory'

# alias fails during run
! exec maru2 -f workflow-with-aliases.yaml local:fails
stderr 'ERRO at fails\[0\] \(file:local-tasks.yaml\?task=fails\)'

-- workflow-absolute-path.yaml --
schema-version: v1
aliases:
  missing:
    path: /non/existent/path/to/file.yaml
tasks:
  test-task:
    steps:
      - run: echo "test"

-- workflow-resolve-error.yaml --
schema-version: v1
aliases:
  missing:
    path: does-not-exist.yaml
tasks:
  main-task:
    steps:
      - run: echo "main"

-- workflow-fetch-error.yaml --
schema-version: v1
aliases:
  invalid:
    path: broken.yaml
tasks:
  main-task:
    steps:
      - run: echo "main"

-- broken.yaml --
this is not valid yaml content
  - malformed
    syntax

-- workflow-with-aliases.yaml --
schema-version: v1
aliases:
  local:
    path: local-tasks.yaml
tasks:
  local-task:
    steps:
      - uses: local:echo-local
  remote-task:
    inputs:
      message:
        description: Message for remote task
        default: hello from remote
    steps:
      - run: echo "${{ input \"message\" }}"

-- local-tasks.yaml --
schema-version: v1
tasks:
  echo-local:
    steps:
      - run: echo "Local alias resolved successfully"
  fails:
    steps:
      - run: exit 1

-- workflow-invalid-url-chars.yaml --
schema-version: v1
aliases:
  invalid:
    path: "path with\x00control\x01chars.yaml"
tasks:
  default:
    steps: []
