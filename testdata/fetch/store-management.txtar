# Test store management and garbage collection with remote workflows

# Test with custom store location
exec maru2 --store ./custom-store --from $HTTP_BASE_URL/simple.yaml hello
stdout 'Hello from remote!'
stderr 'echo.*Hello from remote'

# Verify store directory was created
exists custom-store

# Test garbage collection with store
exec maru2 --store ./custom-store --gc --from $HTTP_BASE_URL/simple.yaml hello
stdout 'Hello from remote!'

# Test fetch-all with custom store and garbage collection
exec maru2 --store ./test-store --fetch-all --gc --from $HTTP_BASE_URL/simple.yaml hello
stdout 'Hello from remote!'
stderr 'echo.*Hello from remote'

# Verify test-store directory was created
exists test-store

# Test that local .maru2/store is preferred over default when it exists
mkdir .maru2
mkdir .maru2/store
exec maru2 --from $HTTP_BASE_URL/simple.yaml hello
stdout 'Hello from remote!'

# Verify .maru2/store was used (not ${HOME}/.maru2/store)
exists .maru2/store

-- tasks.yaml --
schema-version: v1
tasks:
  hello:
    steps:
      - uses: $HTTP_BASE_URL/simple.yaml?task=hello
