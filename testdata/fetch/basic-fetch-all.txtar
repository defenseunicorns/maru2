# Test basic fetch-all functionality

# Test fetch-all with explicit store location and task execution
exec maru2 --store ./store --fetch-all --from $HTTP_BASE_URL/simple.yaml hello
stdout 'Hello from remote!'
stderr 'echo.*Hello from remote'

# Test that fetch-all with never policy fails
! exec maru2 --fetch-policy never --fetch-all
stderr 'ERRO cannot fetch all with fetch policy "never"'

# Test fetch-all with invalid remote reference
! exec maru2 --fetch-all --from $HTTP_BASE_URL/invalid.yaml
stderr 'ERRO.*string was used where mapping is expected'

# Test fetch-all with server error
! exec maru2 --fetch-all --from $HTTP_BASE_URL/error.yaml
stderr 'ERRO.*500 Internal Server Error'

# Test fetch-all with missing dependency
! exec maru2 --fetch-all --from $HTTP_BASE_URL/missing-dependency.yaml
stderr 'ERRO.*404 Not Found'

-- tasks.yaml --
schema-version: v1
tasks:
  hello:
    steps:
      - run: echo "Local hello"
