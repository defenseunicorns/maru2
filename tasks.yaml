# yaml-language-server: $schema=schema/v0/schema.json
schema-version: v0
inputs:
  text:
    description: Text to echo
    default: "Hello, world!"
    required: true
  short:
    description: Controls whether network tests are run
    default: false
  uds-registry:
    description: Registry location to publish nightly to
    default: localhost:5005

tasks:
  echo:
    - run: echo "${{ input "text" }}"

  test:
    - run: |
        go test -race -cover -coverprofile=coverage.out -failfast -timeout 3m -short=${{ input "short" }} ./...

  hello-world:
    - run: echo "Hello, World!"

  benchmark:
    - run: hyperfine './bin/maru2 hello-world' 'make hello-world' -N --warmup 10

  complex:
    - uses: echo
      with:
        text: input was '${{ input "text" }}'
    - run: |
        echo "$INPUT_TEXT"
        echo "${{ input "text" }}"
    - run: echo "bar=baz" >> $MARU2_OUTPUT
      id: foo
    - run: |
        echo "got: ${{ from "foo" "bar" }}"

  release-nightly:
    - run: |
        rm -rf dist
        mkdir -p dist

        title() {
            string="$1"
            first_char=$(printf %.1s "$string" | tr '[:lower:]' '[:upper:]')
            rest_of_string=$(printf %s "$string" | cut -c 2-)
            printf '%s%s\n' "$first_char" "$rest_of_string"
        }

        export CGO_ENABLED=0

        oses=(linux darwin)
        arches=(amd64 arm64)
        for os in "${oses[@]}"; do
          for arch in "${arches[@]}"; do
            if [[ "${os}/${arch}" == "darwin/amd64" ]]; then
              continue
            fi

            platform="$(title "$os")_"
            if [[ "${arch}" == "amd64" ]]; then
              platform+="x86_64"
            else
              platform+="${arch}"
            fi

            echo "build dist/maru2_$platform"
            GOARCH="$arch" GOOS="$os" \
            go build -o "dist/maru2_$platform" -ldflags="-s -w" -trimpath ./cmd/maru2

            echo "build dist/maru2-publish_$platform"
            GOARCH="$arch" GOOS="$os" \
            go build -o "dist/maru2-publish_$platform" -ldflags="-s -w" -trimpath ./cmd/maru2-publish
          done
        done
      shell: bash
    - run: |
        cp LICENSE dist
        cp maru2.schema.json dist
    - run: |
        go tool oras push \
          ${{ input "uds-registry" }}/ops/maru2-nightly:$(../bin/maru2 --version) \
          $(find . -mindepth 1 | sed 's|$|:application/vnd.maru2.release.artifact.v1|') \
          --artifact-type "application/vnd.maru2.release.manifest.v1"
      shell: bash
      dir: dist

  test-nightly:
    - run: |
        version=$(go tool oras repo tags ${{ input "uds-registry" }}/ops/maru2-nightly | tail -n 1)
        echo "version=$version" >> $MARU2_OUTPUT
        echo "downloading maru2@$version"

        manifest=$(go tool oras manifest fetch "${{ input "uds-registry" }}/ops/maru2-nightly:$version")

        platform="$(uname)_$(uname -m)"
        to_fetch=(maru2.schema.json "maru2_$platform" "maru2-publish_$platform")

        for file in "${to_fetch[@]}"; do
          digest=$(echo "$manifest" | jq -r ".layers[] | select(.annotations[\"org.opencontainers.image.title\"] == \"${file}\") | .digest")
          go tool oras blob fetch "${{ input "uds-registry" }}/ops/maru2-nightly@$digest" --output $file
        done

        mv "maru2_$platform" maru2 && chmod +x maru2
        mv "maru2-publish_$platform" maru2-publish && chmod +x maru2-publish
      id: fetch
      shell: bash
    - run: |
        if [[ "$(./maru2 --version)" != "${{ from "fetch" "version" }}" ]]; then
          echo "maru2 version mismatch"
          exit 1
        fi

        if [[ "$(./maru2-publish --version)" != "${{ from "fetch" "version" }}" ]]; then
          echo "maru2-publish version mismatch"
          exit 1
        fi
      shell: bash
    - run: rm -f ./maru2 ./maru2-publish
      if: always()
